import{c as M,i as u,k as h,l as S,p as J,n as K,o as Q,q as A,r as i,u as X,j as e,L as v,M as k,m as y,t as Z}from"./index-BYkX6PAe.js";import{A as D}from"./arrow-left-DKPWIvsU.js";import{U as ee}from"./user-Ayc6N0bg.js";import{C as G}from"./clock-CDKCew_s.js";/**
 * @license lucide-react v0.542.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const te=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],se=M("send",te);/**
 * @license lucide-react v0.542.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ae=[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]],re=M("trash-2",ae);/**
 * @license lucide-react v0.542.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ne=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["path",{d:"M16 3.128a4 4 0 0 1 0 7.744",key:"16gr8j"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}]],oe=M("users",ne),p={CLASSROOM:"classroom",BROADCAST:"broadcast",PLAYGROUND:"playground",UNDERGROUND:"underground"},F={[p.CLASSROOM]:{id:p.CLASSROOM,title:"教室【雑談/交流】",description:"(この値が表示されているときは、サーバがダウンしている可能性があります)",status:"open",order:1},[p.BROADCAST]:{id:p.BROADCAST,title:"放送室【お知らせ/告知】",description:"(この値が表示されているときは、サーバがダウンしている可能性があります)",status:"open",order:2},[p.PLAYGROUND]:{id:p.PLAYGROUND,title:"校庭【感想】",description:"(この値が表示されているときは、サーバがダウンしている可能性があります)",status:"open",order:3},[p.UNDERGROUND]:{id:p.UNDERGROUND,title:"地下【なんでも】",description:"(この値が表示されているときは、サーバがダウンしている可能性があります)",status:"open",order:4}},le=(t,s,r)=>Promise.race([t,new Promise((n,o)=>{setTimeout(()=>{o(new Error(r))},s)})]),ce=1e4,b=t=>le(t,ce,"サーバーへの接続がタイムアウトしました。サーバーがダウンしている可能性があります。"),ie=async()=>{try{const t=u(h,"bulletin_board/boards"),s=await b(S(t));if(!s.exists())return await xe(),Object.values(F).map(n=>({...n,created_at:new Date().toISOString(),created_by:"system",post_count:0}));const r=s.val();return Object.values(r).sort((n,o)=>n.order-o.order)}catch(t){throw console.error("スレの取得に失敗しました:",t),new Error("サーバーへの接続に失敗しました")}},P=async t=>{try{const s=u(h,`bulletin_board/boards/${t}`),r=await b(S(s));return r.exists()?r.val():null}catch(s){throw console.error("スレの取得に失敗しました:",s),new Error("サーバーへの接続に失敗しました")}},R=async(t,s=0,r=20)=>{try{const n=u(h,`bulletin_board/posts/${t}`),o=await b(S(n));if(!o.exists())return{posts:[],hasMore:!1,totalCount:0};const x=o.val(),l=Object.values(x).sort((g,w)=>w.post_number-g.post_number),c=l.length,j=l.slice(s,s+r),m=s+r<c;return{posts:j,hasMore:m,totalCount:c}}catch(n){throw console.error("レスの取得に失敗しました:",n),new Error("サーバーへの接続に失敗しました")}},de=async t=>{try{const{board_id:s,author:r,content:n}=t,o=u(h,`bulletin_board/boards/${s}`),x=await b(S(o));if(!x.exists())throw new Error("スレが存在しません");const c=x.val().post_count+1,j={board_id:s,author:r,content:n,created_at:new Date().toISOString(),post_number:c},m=u(h,`bulletin_board/posts/${s}`),g=J(m),w={...j,id:g.key},f={};return f[`bulletin_board/posts/${s}/${g.key}`]=w,f[`bulletin_board/boards/${s}/post_count`]=c,f[`bulletin_board/boards/${s}/last_updated`]=K(),await b(Q(u(h),f)),await H(),!0}catch(s){return console.error("レスの作成に失敗しました:",s),!1}},H=async()=>{try{const t=u(h,"bulletin_board/boards"),s=u(h,"bulletin_board/posts"),[r,n]=await Promise.all([b(S(t)),b(S(s))]);let o=0,x=0;if(r.exists()&&(o=Object.keys(r.val()).length),n.exists()){const j=n.val();Object.values(j).forEach(m=>{typeof m=="object"&&m!==null&&(x+=Object.keys(m).length)})}const l={total_boards:o,total_posts:x,created_at:new Date().toISOString(),last_updated:new Date().toISOString()},c=u(h,"bulletin_board/metadata");await b(A(c,l))}catch(t){console.error("メタデータの更新に失敗しました:",t)}},xe=async()=>{try{const t=new Date().toISOString(),s={};Object.entries(F).forEach(([n,o])=>{s[n]={...o,created_at:t,created_by:"system",post_count:0}});const r=u(h,"bulletin_board/boards");await b(A(r,s)),await H()}catch(t){console.error("初期スレの作成に失敗しました:",t)}},me=async(t,s)=>{try{const r=u(h,`bulletin_board/posts/${t}/${s}`);return await b(A(r,null)),!0}catch(r){return console.error("レスの削除に失敗しました:",r),!1}},I={getItem:t=>{try{if(typeof window<"u")return window.localStorage.getItem(t)}catch(s){console.error("Error accessing localStorage:",s)}return null},setItem:(t,s)=>{try{typeof window<"u"&&window.localStorage.setItem(t,s)}catch(r){console.error("Error setting localStorage item:",r)}},removeItem:t=>{try{typeof window<"u"&&window.localStorage.removeItem(t)}catch(s){console.error("Error removing localStorage item:",s)}},clear:()=>{try{typeof window<"u"&&window.localStorage.clear()}catch(t){console.error("Error clearing localStorage:",t)}}},ue=({boardId:t})=>{const[s,r]=i.useState(null),[n,o]=i.useState([]),[x,l]=i.useState(!0),[c,j]=i.useState(!1),[m,g]=i.useState(!1),[w,f]=i.useState(!1),[B,C]=i.useState(""),[_,L]=i.useState(""),[U,$]=i.useState(null),{isAdmin:q}=X(),E=20;i.useEffect(()=>{(async()=>{try{l(!0),$(null);const[d,N]=await Promise.all([P(t),R(t,0,E)]);r(d),o(N.posts),g(N.hasMore)}catch(d){console.error("データの取得に失敗しました:",d),$("スレの読み込みに失敗しました。サーバーがダウンしている可能性があります。しばらく時間をおいてから再度お試しください。")}finally{l(!1)}})()},[t]);const T=i.useCallback(async()=>{if(!(c||!m))try{j(!0);const a=await R(t,n.length,E);o(d=>[...d,...a.posts]),g(a.hasMore)}catch(a){console.error("追加レスの取得に失敗しました:",a)}finally{j(!1)}},[t,n.length,c,m]);i.useEffect(()=>{const a=()=>{window.innerHeight+document.documentElement.scrollTop>=document.documentElement.offsetHeight-1e3&&T()};return window.addEventListener("scroll",a),()=>window.removeEventListener("scroll",a)},[T]),i.useEffect(()=>{const a=I.getItem("bulletin_board_username");a!==null&&a!==""&&L(a)},[]);const V=async a=>{if(a.preventDefault(),B.trim()!==""){f(!0);try{const d=_.trim()===""?"名無しさん":_.trim();if(_.trim()!==""&&I.setItem("bulletin_board_username",_.trim()),await de({board_id:t,author:d,content:B.trim()})){C("");const O=await R(t,0,E);o(O.posts),g(O.hasMore);const W=await P(t);r(W)}else console.error("レスに失敗しました"),window.alert("レスに失敗しました。サーバーがダウンしている可能性があります。もう一度お試しください。")}catch(d){console.error("レスエラー:",d),window.alert("レスに失敗しました。サーバーがダウンしている可能性があります。")}finally{f(!1)}}},Y=async a=>{if(window.confirm("このレスを削除しますか？"))try{if(await me(t,a)){const N=await R(t,0,E);o(N.posts),g(N.hasMore);const O=await P(t);r(O)}else window.alert("削除に失敗しました。サーバーがダウンしている可能性があります。")}catch(d){console.error("削除エラー:",d),window.alert("削除に失敗しました。サーバーがダウンしている可能性があります。")}},z=a=>{try{return new Date(a).toLocaleString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}catch{return a}};return x?e.jsx("div",{className:"flex min-h-screen items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mx-auto h-8 w-8 animate-spin rounded-full border-4 border-blue-500 border-t-transparent"}),e.jsx("p",{className:"mt-4 text-gray-600 dark:text-gray-400",children:"読み込み中..."})]})}):U!==null?e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900",children:e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsx("div",{className:"mb-4",children:e.jsxs(v,{to:"/bulletin-board",className:"inline-flex items-center space-x-2 text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300",children:[e.jsx(D,{className:"h-4 w-4"}),e.jsx("span",{children:"BBS一覧に戻る"})]})}),e.jsxs("div",{className:"mx-auto max-w-md text-center",children:[e.jsx("div",{className:"mb-4 rounded-full bg-red-100 p-3 dark:bg-red-900",children:e.jsx(k,{className:"mx-auto h-8 w-8 text-red-600 dark:text-red-400"})}),e.jsx("h2",{className:"mb-2 text-xl font-semibold text-gray-900 dark:text-white",children:"接続エラー"}),e.jsx("p",{className:"mb-4 text-gray-600 dark:text-gray-400",children:U}),e.jsx("button",{onClick:()=>window.location.reload(),className:"rounded-lg bg-blue-600 px-4 py-2 text-white hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600",children:"再読み込み"})]})]})}):s===null?e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900",children:e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"スレが見つかりません"}),e.jsxs(v,{to:"/bulletin-board",className:"mt-4 inline-flex items-center space-x-2 text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300",children:[e.jsx(D,{className:"h-4 w-4"}),e.jsx("span",{children:"BBS一覧に戻る"})]})]})})}):e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900",children:e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsxs(y.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"mb-8",children:[e.jsx("div",{className:"mb-4",children:e.jsxs(v,{to:"/bulletin-board",className:"inline-flex items-center space-x-2 text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300",children:[e.jsx(D,{className:"h-4 w-4"}),e.jsx("span",{children:"BBS一覧に戻る"})]})}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"rounded-lg bg-blue-100 p-3 dark:bg-blue-900",children:e.jsx(k,{className:"h-6 w-6 text-blue-600 dark:text-blue-400"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white",children:s.title}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:s.description}),e.jsxs("div",{className:"mt-2 flex items-center space-x-4 text-sm text-gray-500 dark:text-gray-400",children:[e.jsxs("span",{children:[s.post_count," レス"]}),e.jsx("span",{className:`inline-flex rounded-full px-2 py-1 text-xs font-medium ${s.status==="open"?"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300":"bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300"}`,children:s.status==="open"?"オープン":"クローズ"})]})]})]})]}),s.status==="open"&&e.jsx(y.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"mb-8",children:e.jsxs("div",{className:"rounded-xl border border-gray-200 bg-white p-6 shadow-sm dark:border-gray-700 dark:bg-gray-800",children:[e.jsx("h3",{className:"mb-4 text-lg font-semibold text-gray-900 dark:text-white",children:"新規レス"}),e.jsxs("form",{onSubmit:V,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"userName",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"ユーザー名（任意）"}),e.jsx("input",{type:"text",id:"userName",value:_,onChange:a=>L(a.target.value),placeholder:"ユーザ名",className:"mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none dark:border-gray-600 dark:bg-gray-700 dark:text-white"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"postContent",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"レス内容"}),e.jsx("textarea",{id:"postContent",value:B,onChange:a=>C(a.target.value),rows:4,placeholder:"レス内容を入力してください...",required:!0,className:"mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none dark:border-gray-600 dark:bg-gray-700 dark:text-white"})]}),e.jsxs("button",{type:"submit",disabled:w||B.trim()==="",className:"inline-flex items-center space-x-2 rounded-lg bg-blue-600 px-4 py-2 text-white transition-colors hover:bg-blue-700 disabled:cursor-not-allowed disabled:bg-gray-400",children:[e.jsx(se,{className:"h-4 w-4"}),e.jsx("span",{children:w?"レス中...":"書き込む"})]})]})]})}),e.jsx(y.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.2},className:"space-y-4",children:n.map((a,d)=>e.jsx(y.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:d*.05},className:"rounded-xl border border-gray-200 bg-white shadow-sm dark:border-gray-700 dark:bg-gray-800",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"mb-4 flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"flex h-8 w-8 items-center justify-center rounded-full bg-blue-100 dark:bg-blue-900",children:e.jsx(ee,{className:"h-4 w-4 text-blue-600 dark:text-blue-400"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-white",children:a.author}),e.jsxs("div",{className:"flex items-center space-x-2 text-sm text-gray-500 dark:text-gray-400",children:[e.jsx(G,{className:"h-3 w-3"}),e.jsx("span",{children:z(a.created_at)}),e.jsxs("span",{children:["#",a.post_number]})]})]})]}),q&&e.jsx("div",{className:"flex space-x-2",children:e.jsx("button",{onClick:()=>Y(a.id),className:"rounded-lg p-2 text-red-600 transition-colors hover:bg-red-100 dark:text-red-400 dark:hover:bg-red-900",title:"レスを削除",children:e.jsx(re,{className:"h-4 w-4"})})})]}),e.jsx("div",{className:"whitespace-pre-wrap text-gray-700 dark:text-gray-300",children:a.content})]})},a.id))}),c&&e.jsx("div",{className:"flex justify-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mx-auto h-6 w-6 animate-spin rounded-full border-4 border-blue-500 border-t-transparent"}),e.jsx("p",{className:"mt-2 text-sm text-gray-600 dark:text-gray-400",children:"レスを読み込み中..."})]})}),!m&&n.length>0&&e.jsx("div",{className:"py-8 text-center",children:e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"すべてのレスを表示しました"})}),n.length===0&&e.jsxs(y.div,{initial:{opacity:0},animate:{opacity:1},className:"py-12 text-center",children:[e.jsx(k,{className:"mx-auto h-16 w-16 text-gray-400"}),e.jsx("h3",{className:"mt-4 text-lg font-medium text-gray-900 dark:text-white",children:"まだレスがありません"}),e.jsx("p",{className:"mt-2 text-gray-600 dark:text-gray-400",children:"最初のレスをしてみませんか？"})]})]})})},he=()=>{const[t,s]=i.useState([]),[r,n]=i.useState(!0),[o,x]=i.useState(null);return i.useEffect(()=>{(async()=>{try{x(null);const c=await ie();s(c)}catch(c){console.error("スレの取得に失敗しました:",c),x("BBSの読み込みに失敗しました。サーバーがダウンしている可能性があります。しばらく時間をおいてから再度お試しください。")}finally{n(!1)}})()},[]),r?e.jsx("div",{className:"flex min-h-screen items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mx-auto h-8 w-8 animate-spin rounded-full border-4 border-blue-500 border-t-transparent"}),e.jsx("p",{className:"mt-4 text-gray-600 dark:text-gray-400",children:"読み込み中..."})]})}):o!==null?e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900",children:e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsx("div",{className:"mb-4",children:e.jsxs(v,{to:"/",className:"inline-flex items-center space-x-2 text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300",children:[e.jsx(D,{className:"h-4 w-4"}),e.jsx("span",{children:"ホームに戻る"})]})}),e.jsxs("div",{className:"mx-auto max-w-md text-center",children:[e.jsx("div",{className:"mb-4 rounded-full bg-red-100 p-3 dark:bg-red-900",children:e.jsx(k,{className:"mx-auto h-8 w-8 text-red-600 dark:text-red-400"})}),e.jsx("h2",{className:"mb-2 text-xl font-semibold text-gray-900 dark:text-white",children:"接続エラー"}),e.jsx("p",{className:"mb-4 text-gray-600 dark:text-gray-400",children:o}),e.jsx("button",{onClick:()=>window.location.reload(),className:"rounded-lg bg-blue-600 px-4 py-2 text-white hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600",children:"再読み込み"})]})]})}):e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900",children:e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsxs(y.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"mb-8",children:[e.jsx("div",{className:"mb-4",children:e.jsxs(v,{to:"/",className:"inline-flex items-center space-x-2 text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300",children:[e.jsx(D,{className:"h-4 w-4"}),e.jsx("span",{children:"ホームに戻る"})]})}),e.jsx("h1",{className:"mb-4 text-4xl font-bold text-gray-900 dark:text-white",children:"BBS"}),e.jsx("p",{className:"text-lg text-gray-600 dark:text-gray-400",children:"数学部のBBSへようこそ！"})]}),e.jsx(y.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.2},className:"grid gap-6 md:grid-cols-2 lg:grid-cols-3",children:t.map((l,c)=>e.jsx(y.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:c*.1},children:e.jsx(v,{to:`/bulletin-board?board=${l.id}`,className:"group block",children:e.jsxs("div",{className:"h-full rounded-xl border border-gray-200 bg-white p-6 shadow-sm transition-all duration-300 hover:border-blue-300 hover:shadow-lg dark:border-gray-700 dark:bg-gray-800 dark:hover:border-blue-600",children:[e.jsx("div",{className:"mb-4 flex items-start justify-between",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"rounded-lg bg-blue-100 p-2 dark:bg-blue-900",children:e.jsx(k,{className:"h-5 w-5 text-blue-600 dark:text-blue-400"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900 group-hover:text-blue-600 dark:text-white dark:group-hover:text-blue-400",children:l.title}),e.jsx("div",{className:`mt-1 inline-flex rounded-full px-2 py-1 text-xs font-medium ${l.status==="open"?"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300":"bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300"}`,children:l.status==="open"?"オープン":"クローズ"})]})]})}),e.jsx("p",{className:"mb-4 text-sm text-gray-600 dark:text-gray-400",children:l.description}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("div",{className:"flex items-center space-x-4",children:e.jsxs("div",{className:"flex items-center space-x-1 text-gray-500 dark:text-gray-400",children:[e.jsx(oe,{className:"h-4 w-4"}),e.jsxs("span",{children:[l.post_count," レス"]})]})}),e.jsxs("div",{className:"flex items-center space-x-1 text-gray-500 dark:text-gray-400",children:[e.jsx(G,{className:"h-4 w-4"}),e.jsxs("span",{children:["#",l.order]})]})]})]})})},l.id))}),t.length===0&&!r&&e.jsxs(y.div,{initial:{opacity:0},animate:{opacity:1},className:"py-12 text-center",children:[e.jsx(k,{className:"mx-auto h-16 w-16 text-gray-400"}),e.jsx("h3",{className:"mt-4 text-lg font-medium text-gray-900 dark:text-white",children:"スレがありません"}),e.jsx("p",{className:"mt-2 text-gray-600 dark:text-gray-400",children:"まだスレが作成されていません。"})]})]})})},je=()=>{const[t]=Z(),s=t.get("board");return s!==null&&Object.values(p).includes(s)?e.jsx(ue,{boardId:s}):e.jsx(he,{})};export{je as default};
//# sourceMappingURL=BulletinBoard-BqH5HK6j.js.map
